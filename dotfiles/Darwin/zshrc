# Conigure shell history options
HISTFILE="$HOME/.zsh_history"
HISTSIZE=10000 # History in memory
SAVEHIST=10000 # Lines in the HISTFILE

# Set shell prompt
PS1="%F{red}Â»%f "

# Customize `ls` colours
export CLICOLOR=1
export LSCOLORS=BxAhHxDxCxegedabagaced

# Configure default editor to Vim
export EDITOR=vim

#setopt EXTENDED_HISTORY # Adds timestamps and exit statuses to each entry saved in HISTFILE
setopt HIST_APPEND # Append history, instead of overwriting it
setopt HIST_IGNORE_ALL_DUPS # Ignore duplicate commands
setopt HIST_IGNORE_SPACE # Ignore commands that start with a space
setopt HIST_REDUCE_BLANKS # Trim excess blanks
setopt HIST_SAVE_NO_DUPS # Prevent saving duplicates to history
setopt HIST_VERIFY # Ask for confirmation before executing a history-expanded command
setopt INC_APPEND_HISTORY # Write to the history file after each command
setopt SHARE_HISTORY # Share history between sessions

# Ensure immediate history updates
#precmd() {
#  history -a &>/dev/null # Append history after every command
#  history -n &>/dev/null # Read new history from the history file
#}

# Shell completions user dir
[[ -d "$HOME/.zsh/zfunc" ]] || mkdir -p "$HOME/.zsh/zfunc"
fpath+=("$HOME/.zsh/zfunc")

autoload -Uz +X compinit && compinit # Enable completion system
autoload -Uz +X bashcompinit && bashcompinit # Enable bash-style completion

# Use caching to speed up completion startup
[[ -d "$HOME/.zsh/cache" ]] || mkdir -p "$HOME/.zsh/cache"

zstyle ':completion::complete:*' use-cache on
zstyle ':completion::complete:*' cache-path "$HOME/.zsh/cache"

# Show completion menu when multiple options exist
zstyle ':completion:*' menu select
zstyle ':completion:*' list-colors ''

# Fast completion (no description)
#zstyle ':completion:*' verbose no
#zstyle ':completion:*' format '%d'
zstyle ':completion:*' group-name ''

# Skip unnecessary prompt recalculations
zstyle ':completion:*' rehash true

setopt auto_menu # Show completion menu on successive tab

# Tools integration
# Command-line fuzzy finder
# https://github.com/junegunn/fzf
if command -v fzf >/dev/null 2>&1; then
    export FZF_DEFAULT_OPTS="--height=40% \
--layout=reverse \
--info=inline-right \
--color=16 \
--pointer=\"\" \
--cycle"
    . <(fzf --zsh)
fi

# HashiCorp Terraform
# https://developer.hashicorp.com/terraform
if command -v terraform >/dev/null 2>&1; then
    complete -o nospace -C "$(command -v terraform)" terraform
fi

# AWS CLI
# https://docs.aws.amazon.com/cli/latest/reference
if command -v aws >/dev/null 2>&1; then
    complete -o nospace -C "$(command -v aws_completer)" aws
fi

# 1Password CLI
# https://developer.1password.com/docs/cli
if command -v op >/dev/null 2>&1; then
    eval "$(op completion zsh)"; compdef _op op
fi

# Setup environment for Rust lang
# https://rust-lang.org
if [[ -f "$HOME/.cargo/env" ]]; then
    . "$HOME/.cargo/env"
fi

# Rust lang shell completions
if command -v rustup >/dev/null 2>&1; then
    test -f "$HOME/.zsh/zfunc/_rustup" || rustup completions zsh > "$HOME/.zsh/zfunc/_rustup"
    test -f "$HOME/.zsh/zfunc/_cargo" || rustup completions zsh cargo > "$HOME/.zsh/zfunc/_cargo"
fi

# Kubernetes kubectl
# https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands
if command -v kubectl >/dev/null 2>&1; then
    test -f "$HOME/.zsh/zfunc/_kubectl" || kubectl completion zsh > "$HOME/.zsh/zfunc/_kubectl"
fi

# Jujutsu VCS
# https://github.com/jj-vcs/jj
if command -v jj >/dev/null 2>&1; then
    test -f "$HOME/.zsh/zfunc/_jj" || jj util completion zsh > ~/.zsh/zfunc/_jj
fi

# bat: a cat(1) clone with syntax highlighting and Git integration
# https://github.com/sharkdp/bat
if command -v bat >/dev/null 2>&1; then
    test -f "$HOME/.zsh/zfunc/_bat" || bat --completion zsh > ~/.zsh/zfunc/_bat
    export BAT_THEME_DARK="Nord"
fi

# Aliases
# Prefer Podman over Docker in this environment. Docker is largely deprecated
# here and typically requires root/VM on macOS; use rootless Podman instead.
if command -v podman >/dev/null 2>&1; then
    alias docker='podman'
fi

# If there's no `claude` tool in the system, then use temporary `npx` package.
if ! command -v claude >/dev/null 2>&1; then
    alias claude='npx @anthropic-ai/claude-code'
fi

# If there's no `codex` tool in the system, then use temporary `npx` package.
if ! command -v codex >/dev/null 2>&1; then
    alias codex='npx @openai/codex'
fi

# Functions
# Erase from top of screen to cursor.
# Redraw prompt + input buffer.
clear_above() {
    print -Pn "\e[1J"

    zle redisplay
}

# Explicitly set default Emacs mode in a shell.
# Some utilities potentially can:
# 1. override default shell's key bindings;
# 2. override default zsh mode (eg. bindkey -v).
bindkey -e

# Remap Ctrl+L to clear terminal screen above prompt
# (temporary maybe until i found new shortcut)
zle -N clear-above clear_above
bindkey '^L' clear-above

# Avoid duplicates in PATH
typeset -U path
export PATH
